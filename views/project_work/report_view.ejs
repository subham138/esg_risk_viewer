<%- include('../templates/header.ejs') %>
<script src="js/chart/google/google-chart-loader.js"></script>

<!-- morris-chart -->
    <script src="js/chart/morris-chart/raphael.js"></script>
    <script src="js/chart/morris-chart/morris.js"> </script>
    <script src="js/chart/morris-chart/prettify.min.js"></script>
    <script src="js/chart/morris-chart/morris.min.js"></script>
    <script src="js/chart/morris-chart/morris-script.js"></script>
<!-- END -->

<style>
    .topic_text {
      text-align: center;
      vertical-align: middle;
    }
  </style>
<script>
    google.charts.load('current', {packages: ['corechart', 'bar', 'line']});
    var fun = {}, i = 1, wordList = {}, totCount ={};
</script>
<div class="container-fluid">
    <div class="page-header">
        <div class="row">
            <div class="col-sm-6">
                <h3><%= header %></h3>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="<%= header_url %>"><%= header %></a></li>
                    <li class="breadcrumb-item"><%= sub_header %></li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <p class="pro-card-head">You are working on the project <b><%= projName %></b></p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 row m-b-15">
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 mt-2">
                                <div class="u-step" dt-for="IFRS">
                                    <div class="u-step-desc text-center"><span class="u-step-title">IFRS</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 mt-2">
                                <div class="u-step" dt-for="ESRS">
                                    <div class="u-step-desc text-center"><span class="u-step-title">ESRS</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 mt-2">
                                <div class="u-step" dt-for="GRI">
                                    <div class="u-step-desc text-center"><span class="u-step-title">GRI</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 mt-2">
                                <div class="u-step" dt-for="SFDR">
                                    <div class="u-step-desc text-center"><span class="u-step-title">SFDR</span>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 mt-2">
                                <div class="u-step" dt-for="TCFD">
                                    <div class="u-step-desc text-center"><span class="u-step-title">TCFD</span>
                                    </div>
                                </div>
                            </div> -->
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 mt-2">
                                <div class="u-step" dt-for="voluntaryreporting">
                                    <div class="u-step-desc text-center"><span class="u-step-title">Voluntary Reporting</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="downloadFull">
                        <div class="row" id="topic_metrics_data">
                            <div class="col-md-12">
                                <div class="default-according style-1" id="accordionoc">
                                    <div class="card">
                                        <div class="card-header bg-primary caruBackCol">
                                            <h5 class="mb-0">
                                                <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#disTop" aria-expanded="true" aria-controls="collapse11">Disclosure topics</button>
                                            </h5>
                                        </div>
                                        <div class="collapse m-3 show" id="disTop" aria-labelledby="disTop" data-bs-parent="#accordionoc">
                                            <div class="row">
                                                <div class="col-md-12 m-b-10">
                                                    <p class="dyn-col-head">Sustainability Disclosure Topics & Metrics</p>
                                                </div>
                                                <div class="col-md-12">
                                                    <table class="table" width="100%">
                                                        <thead>
                                                            <tr class="tbDynDt">
                                                                <th>General issue category (Industry agnostic)</th>
                                                                <th>Disclosure topics (Industry specific)</th>
                                                                <th>Metric</th>
                                                                <th>Category</th>
                                                                <th>Unit of measure</th>
                                                                <th>Code</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% if(susDistList.msg.length > 0){
                                                                var rowSpan = 1
                                                                var prevRes = ''
                                                                var susModifyDt = susDistList.msg.map(dt => dt.code != '' && dt.code != 'null' && dt.code ? dt : null)
                                                                susModifyDt = susModifyDt.filter(dt => dt != undefined)
                                                                susModifyDt.forEach(dt => {
                                                                    if(typeof(dt) === 'object'){
                                                                    var nowRes = dt.top_id
                                                                    %>
                                                                    <tr class="hoverDynDtaTbl">
                                                                        <% if(prevRes != nowRes){
                                                                            prevRes = dt.top_id %>
                                                                            <td class="topic_text" rowspan="<%= susModifyDt.filter(sdt => sdt.top_id == dt.top_id).length %>">
                                                                                <%= dt.topic_name %>
                                                                            </td>
                                                                        <% } %>
                                                                        <td><%= dt.ind_agn %></td>
                                                                        <td><%= dt.metric %></td>
                                                                        <td><%= dt.catg %></td>
                                                                        <td><%= dt.unit %></td>
                                                                        <td><%= dt.code %></td>
                                                                    </tr>
                                                                <% }})
                                                            } %>
                                                            <tr></tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="col-md-12 m-b-10">
                                                    <p class="dyn-col-head">Activity Metrics</p>
                                                </div>
                                                <div class="col-md-12 my-3">
                                                    <table class="table" width="100%">
                                                        <thead>
                                                            <tr class="tbDynDt">
                                                                <th>Activity metric</th>
                                                                <th>Category</th>
                                                                <th>Unit of measure</th>
                                                                <th>Code</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% if(metric.msg.length > 0){
                                                                metric.msg.forEach(dt => { %>
                                                                    <tr class="hoverDynDtaTbl">
                                                                        <td><%= dt.act_metric %></td>
                                                                        <td><%= dt.catg %></td>
                                                                        <td><%= dt.unit %></td>
                                                                        <td><%= dt.code %></td>
                                                                    </tr>
                                                                <% })
                                                            } %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- <div class="card">
                                        <div class="card-header bg-primary">
                                            <h5 class="mb-0">
                                                <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#dynData" aria-expanded="true" aria-controls="collapse11"><%= topName %></button>
                                            </h5>
                                        </div>
                                        <div class="collapse" id="dynData" aria-labelledby="dynData" data-bs-parent="#accordionoc">
                                            <div class="row p-3">
                                                <div class="col-md-12"> -->
                                                    
                                                <!-- </div>
                                            </div>
                                        </div>
                                    </div> -->
                                    
                                </div>
                            </div>
                        </div>
                        <div class="row m-t-10">
                            <div class="col-md-12">
                                <div class="default-according style-1" id="expoAccordionoc">
                                    <div class="card">
                                        <div class="card-header bg-primary caruBackCol">
                                            <h5 class="mb-0">
                                                <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#exposi" aria-expanded="true" aria-controls="collapse11">Exposure</button>
                                            </h5>
                                        </div>
                                        <div class="collapse show" id="exposi" aria-labelledby="exposi" data-bs-parent="#expoAccordionoc">
                                            <div class="row m-3">
                                                <div class="col-md-12">
                                                    <div class="default-according style-2" id="inExpoAccordionoc">
                                                        <% if(allDynamicData.length > 0){
                                                            var rowSpan = 1
                                                            var prevRes = ''
                                                            var dynDataLen = Object.keys(data_set).length
                                                            allDynamicData.forEach(dt => {
                                                            %>
                                                            <div class="card">
                                                                <div class="card-header bg-primary caruBackCol1">
                                                                    <h5 class="mb-0">
                                                                        <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#dynData_<%= dt.top_id %>" aria-expanded="true" aria-controls="collapse11"><%= dt.topic_name %></button>
                                                                    </h5>
                                                                </div>
                                                                <div class="collapse" id="dynData_<%= dt.top_id %>" aria-labelledby="dynData_<%= dt.top_id %>" data-bs-parent="#accordionoc">
                                                                    <% if(top_id == dt.top_id){ %>
                                                                        <% if(resDt.length > 0){
                                                                            var i = 1;
                                                                            var j = 1;
                                                                            resDt.forEach(dt => { %>
                                                                                <div class="row m-3" id="dynamic_data_<%= j %>">
                                                                                    <% if(dt.heading){ %> <h4><%= dt.heading %></h4> <% } %>
                                                                                    <% if(dt.sub_heading){ %> <h5><%= dt.sub_heading %></h5> <% } %>
                                                                                    <% if(dt.icon){ %>
                                                                                        <div class="col-md-2">
                                                                                            <img src="images/icons/<%= dt.icon %>.png" id="<%= dt.icon %>" width="100" height="100" alt="" srcset="" style="border: black 1px solid;">
                                                                                        </div>
                                                                                        <% if(dt.textarea){ %>
                                                                                            <div class="col-md-10">
                                                                                                <%= dt.textarea %>
                                                                                            </div> 
                                                                                    <% }}else{ %> 
                                                                                        <% if(dt.textarea){ %>
                                                                                            <div class="col-md-12">
                                                                                                <%= dt.textarea %>
                                                                                            </div>
                                                                                    <% }} %>
                                                                                    <% if(dt.table){ %>
                                                                                        <div class="col-md-12 m-t-5">
                                                                                            <table class="table m-t-5">
                                                                                                <tr>
                                                                                                    <% dt.table.head.forEach(tdt => { %>
                                                                                                        <th><%= tdt %></th>
                                                                                                    <% }) %>
                                                                                                </tr>
                                                                                                <tbody>
                                                                                                    <% var table_data = [];
                                                                                                        table_data.push(dt.table.head)
                                                                                                        dt.table.body.forEach(trdt => {
                                                                                                            table_data.push([...Object.values(trdt).map(dt => parseFloat(dt) ? Number(dt) : dt)])
                                                                                                        %>
                                                                                                        <tr>
                                                                                                            <% Object.values(trdt).forEach(vdt => { %>
                                                                                                                <td><%= vdt %></td>
                                                                                                            <% }) %>
                                                                                                        </tr>
                                                                                                    <% }) %>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                    <% i++; } %>
                                                                                </div>
                                                                                <!-- <div class="row mt-3">
                                                                                    <div class="col-md-12">
                                                                                        <button class="btn btn-pill btn-outline-primary btn-air-primary float-end" data-bs-original-title title="Download Topics & Metrics" onclick="downloadPrf('dynamic_data_<%= j %>', 'Activity_Metrics')"><i class="icofont icofont-download"></i> Download</button>
                                                                                    </div>
                                                                                </div> -->
                                                                        <% j++; })
                                                                        } %>
                                                                    <% }else if(dynDataLen > 0){
                                                                        if(data_set[dt.top_id]){
                                                                            var i = 1;
                                                                            var j = 1;
                                                                            data_set[dt.top_id].forEach(dt => { %>
                                                                                <div class="row m-3" id="dynamic_data_<%= j %>">
                                                                                    <% if(dt.heading){ %> <h4><%= dt.heading %></h4> <% } %>
                                                                                    <% if(dt.sub_heading){ %> <h5><%= dt.sub_heading %></h5> <% } %>
                                                                                    <% if(dt.icon){ %>
                                                                                        <div class="col-md-2">
                                                                                            <img src="images/icons/<%= dt.icon %>.png" id="<%= dt.icon %>" width="100" height="100" alt="" srcset="" style="border: black 1px solid;">
                                                                                        </div>
                                                                                        <% if(dt.textarea){ %>
                                                                                            <div class="col-md-10">
                                                                                                <%= dt.textarea %>
                                                                                            </div> 
                                                                                    <% }}else{ %> 
                                                                                        <% if(dt.textarea){ %>
                                                                                            <div class="col-md-12">
                                                                                                <%= dt.textarea %>
                                                                                            </div>
                                                                                    <% }} %>
                                                                                    <% if(dt.table){ %>
                                                                                        <div class="col-md-12 m-t-5">
                                                                                            <table class="table m-t-5">
                                                                                                <tr>
                                                                                                    <% dt.table.head.forEach(tdt => { %>
                                                                                                        <th><%= tdt %></th>
                                                                                                    <% }) %>
                                                                                                </tr>
                                                                                                <tbody>
                                                                                                    <% var table_data = [];
                                                                                                        table_data.push(dt.table.head)
                                                                                                        dt.table.body.forEach(trdt => {
                                                                                                            table_data.push([...Object.values(trdt).map(dt => parseFloat(dt) ? Number(dt) : dt)])
                                                                                                        %>
                                                                                                        <tr>
                                                                                                            <% Object.values(trdt).forEach(vdt => { %>
                                                                                                                <td><%= vdt %></td>
                                                                                                            <% }) %>
                                                                                                        </tr>
                                                                                                    <% }) %>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                    <% i++; } %>
                                                                                </div>
                                                                        <% })}else{ %>
                                                                            <div class="row">
                                                                                <div class="col-md-12 text-center p-3">
                                                                                    <p class="h6 text-danger">No Data Available</p>
                                                                                </div>
                                                                            </div>
                                                                       <% } %>
                                                                    <% }else { %>
                                                                        <div class="row">
                                                                            <div class="col-md-12 text-center p-3">
                                                                                <p class="h6 text-danger">No Data Available</p>
                                                                            </div>
                                                                        </div>
                                                                    <% } %>
                                                                </div>
                                                            </div>
                                                            <% })
                                                        } %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button class="btn btn-pill btn-outline-primary btn-air-primary float-end" data-bs-original-title title="Download Full Download Section" onclick="downloadPrf('downloadFull', 'FullDownload')"><i class="icofont icofont-download-alt"></i> Download</button>
                        </div>
                    </div>
                    <div class="row m-t-10">
                        <!-- <script src="https://cdn.ckeditor.com/ckeditor5/38.1.0/classic/ckeditor.js"></script> -->
                        <div class="col-md-12">
                            <div class="default-according style-1" id="editorAcord">
                                <div class="card">
                                    <div class="card-header bg-primary caruBackCol">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#ifrs" aria-expanded="true" aria-controls="collapse11">Manage Disclosure Topics (IFRS)</button>
                                        </h5>
                                    </div>
                                    <div class="collapse" id="ifrs" aria-labelledby="ifrs" data-bs-parent="#editorAcord">
                                        <div class="row">
                                            <% if(user_type != 'V'){ %>
                                                <div class="col-md-12 row mt-3" id="editorPrevDiv">
                                                    <div class="col-md-10">&nbsp;</div>
                                                    <div class="col-md-2">
                                                        <button class="btn btn-pill btn-sm btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Add New Editor" onclick="AddEditor()"><i class="icofont icofont-ui-add"></i><span>&nbsp;&nbsp;Add</span></button>
                                                    </div>
                                                </div>
                                            <% } %>
                                            <div id="editorDiv" class="row">
                                                <% var filetrTopic = susDistList.msg.length > 0 ? susDistList.msg : []
                                                    if(filetrTopic.length > 0){
                                                        var prevRes = ''
                                                        var ediR = 1
                                                        filetrTopic.forEach(dt => {
                                                            var getRes = editorData.filter(edt => edt.article_code == dt.code && edt.top_id==dt.top_id)
                                                            var nowRes = dt.top_id
                                                            %>
                                                            <div id="editorNewDiv_<%= ediR %>" class="row m-t-10">
                                                                <% if(prevRes != nowRes){
                                                                    prevRes = dt.top_id %>
                                                                    <p class="dyn-col-head"><%= dt.topic_name %></p>
                                                                <% } %>
                                                                <div class="<%= ai_tag_tool_flag != 'N' ? 'col-md-8' : 'col-md-12' %> m-l-10 row">
                                                                    <div class="col-md-1 ediDiv">
                                                                        <div for="editor_topic_<%= ediR %>" class="editLabelBull"></div>
                                                                    </div>
                                                                    <div class="col-md-6">
                                                                        <input class="form-control" type="text" name="editor_topic_<%= dt.top_id %>" id="editor_topic_<%= ediR %>" value="<%= dt.code %>">
                                                                    </div>
                                                                    <div class="col-md-12 colEditor">
                                                                        <textarea id="editor<%= ediR %>" name="editor" cols="30" rows="10"><%= getRes.length > 0 ? getRes[0].article : "" %></textarea>
                                                                    </div>
                                                                </div>
                                                                <% if(ai_tag_tool_flag != 'N'){
                                                                    if(dt.words != '' && dt.words && dt.words != 'null'){
                                                                    var word_list = dt.words.trim().split(',');
                                                                    if(word_list.length > 0){ %>
                                                                        <script>
                                                                            wordList[<%= ediR %>] = '<%= dt.words %>';
                                                                            // console.log(wordList)
                                                                        </script>
                                                                        <div class="col-md-4 row">
                                                                            <div class="wordContainer">
                                                                                <div class="wordHeader">
                                                                                    <div class="u-step done">
                                                                                        <div class="u-step-desc text-center">
                                                                                            <span class="u-step-title">Check Alignment/Misalignment</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="wordSubHeader">
                                                                                    <p>ESG-related words included by your peers and not included in your text:</p>
                                                                                </div>
                                                                                <div class="wordCount">
                                                                                    <span id="countMatchNum_<%= ediR %>">0</span> <span>words</span>
                                                                                </div>
                                                                                <div class="wordButton col-md-12 row" id="countMatch_<%= ediR %>">
                                                                                <% word_list.forEach(dt => { %>
                                                                                    <div class="col-md-6 mt-2">
                                                                                        <div class="u-step">
                                                                                            <div class="u-step-desc text-center"><span class="u-step-title"><%= dt %></span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                <% }) %>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    <% } %>
                                                                <% }} %>
                                                                
                                                                <script>
                                                                    CKEDITOR
                                                                    .replace('editor<%= ediR %>', {
                                                                        on: {
                                                                            contentDom: function( evt ) {
                                                                                // Allow custom context menu only with table elemnts.
                                                                                evt.editor.editable().on('contextmenu', function( contextEvent ) {
                                                                                    var path = evt.editor.elementPath();
                        
                                                                                    if ( !path.contains( 'table' ) ) {
                                                                                        contextEvent.cancel();
                                                                                    }
                                                                                }, null, null, 5 );
                                                                            },
                                                                            change: function(e){
                                                                                // console.log(e.editor.getData());
                                                                                var ai_flag = '<%= ai_tag_tool_flag %>';
                                                                                if(ai_flag != 'N'){
                                                                                    totCount[<%= ediR %>] = 0
                                                                                    var editorVal = e.editor.getData()
                                                                                    var plainText = $("<div>").html(editorVal).text();
                                                                                    var txtArr = plainText.trim().split('\n').join(' ').split(' ')
                                                                                    // txtArr.map(dt => dt.trim().split('\n').join('').toLowerCase())
                                                                                    // console.log('len', txtArr);
                                                                                    if(txtArr.length > 0){
                                                                                        txtArr = [...new Set(txtArr)]
                                                                                        // console.log(txtArr, 'TOt array');
                                                                                        var matchTxt = txtArr.filter(dt => increseCount(dt, '<%= ediR %>'))
                                                                                        if(matchTxt.length > 0){
                                                                                            // console.log(matchTxt, 'Match array');
                                                                                            $('#countMatch_<%= ediR %> .u-step').each(function(){
                                                                                                $(this).removeClass('done')
                                                                                            })
                                                                                            for(let dt of matchTxt){
                                                                                                $('#countMatch_<%= ediR %> .u-step').each(function(){
                                                                                                    // console.log($(this).text());
                                                                                                    // if(matchTxt.includes($(this).text().trim().toLowerCase()))
                                                                                                    if($(this).text().trim().split(' ').join('').toLowerCase() == dt.trim().split(' ').join('').toLowerCase())
                                                                                                        $(this).addClass('done')
                                                                                                })
                                                                                            }
                                                                                        }else{
                                                                                            $('#countMatch_<%= ediR %> .u-step').each(function(){
                                                                                                $(this).removeClass('done')
                                                                                            })
                                                                                        }
                                                                                        // txtArr.filter(dt => console.log(dt.trim().split('\n').join('').toLowerCase()))
                                                                                        // console.log(totCount);
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    } );
                                                                </script>
                                                                <% if(user_type != 'V'){ %>
                                                                    <div class="col-md-10">&nbsp;</div>
                                                                    <div class="col-md-2 m-t-10">
                                                                        <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save <%= dt.code %>" onclick="saveEditorValue('<%= ediR %>', '<%= top_id > 0 ? top_id : dt.top_id %>')"><i class="icofont icofont-save"></i> Save</button>
                                                                    </div>
                                                                <% } %>
                                                            </div>
                                                        <% ediR++; })
                                                        var topList = [...filetrTopic.map(dt => dt.code)]
                                                        if(editorData.length > 0){
                                                            var i = ediR > 0 ? ediR + 1 : 1
                                                            editorData.forEach(dt => {
                                                                if(!topList.includes(dt.article_code)){ %>
                                                                    <div id="editorNewDiv_<%= i %>" class="row mt-3">
                                                                        <div class="<%= ai_tag_tool_flag != 'N' ? 'col-md-8' : 'col-md-12' %> m-3 row">
                                                                            <div class="col-md-1 ediDiv">
                                                                                <div for="editor_topic_<%= i %>" class="editLabelBull"></div>
                                                                            </div>
                                                                            <div class="col-md-6">
                                                                                <input type="text" class="form-control" name="editor_topic" id="editor_topic_<%= i %>" value="<%= dt.article_code %>">
                                                                            </div>
                                                                            <div class="col-md-12 colEditor">
                                                                                <textarea id="editor<%= i %>" name="editor" cols="30" rows="10"><%= dt.article %></textarea>
                                                                            </div>
                                                                        </div>
                                                                        <script>
                                                                            CKEDITOR
                                                                            .replace( 'editor<%= i %>', {
                                                                                on: {
                                                                                    contentDom: function( evt ) {
                                                                                        // Allow custom context menu only with table elemnts.
                                                                                        evt.editor.editable().on( 'contextmenu', function( contextEvent ) {
                                                                                            var path = evt.editor.elementPath();
                                    
                                                                                            if ( !path.contains( 'table' ) ) {
                                                                                                contextEvent.cancel();
                                                                                            }
                                                                                        }, null, null, 5 );
                                                                                    }
                                                                                }
                                                                            } );
                                                                        </script>
                                                                        <% if(user_type != 'V'){ %>
                                                                            <div class="col-md-10">&nbsp;</div>
                                                                            <div class="col-md-2 m-t-10">
                                                                                <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save <%= dt.code %>" onclick="saveEditorValue('<%= i %>', '<%= top_id > 0 ? top_id : dt.top_id %>')"><i class="icofont icofont-save"> Save</i></button>
                                                                            </div>
                                                                        <% } %>
                                                                    </div>
                                                                <% }
                                                            i++;})
                                                        }
                                                    }
                                                %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header bg-primary caruBackCol">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#gri" aria-expanded="true" aria-controls="collapse11">Manage Disclosure Topics (GRI)</button>
                                        </h5>
                                    </div>
                                    <div class="collapse" id="gri" aria-labelledby="gri" data-bs-parent="#editorAcord">
                                        <div class="row">
                                            <div class="col-md-12 text-center p-3">
                                                <p class="h6 text-danger">No Data Available</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header bg-primary caruBackCol">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#tcfd" aria-expanded="true" aria-controls="collapse11">Manage Disclosure Topics (TCFD)</button>
                                        </h5>
                                    </div>
                                    <div class="collapse" id="tcfd" aria-labelledby="tcfd" data-bs-parent="#editorAcord">
                                        <div class="row">
                                            <div class="col-md-12 text-center p-3">
                                                <p class="h6 text-danger">No Data Available</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header bg-primary caruBackCol">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#esrs" aria-expanded="true" aria-controls="collapse11">Manage Disclosure Topics (ESRS)</button>
                                        </h5>
                                    </div>
                                    <div class="collapse" id="esrs" aria-labelledby="esrs" data-bs-parent="#editorAcord">
                                        <div class="row">
                                            <div class="col-md-12 text-center p-3">
                                                <p class="h6 text-danger">No Data Available</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header bg-primary caruBackCol">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#serc" aria-expanded="true" aria-controls="collapse11">Manage Disclosure Topics (SECR)</button>
                                        </h5>
                                    </div>
                                    <div class="collapse" id="serc" aria-labelledby="serc" data-bs-parent="#editorAcord">
                                        <div class="row">
                                            <div class="col-md-12 text-center p-3">
                                                <p class="h6 text-danger">No Data Available</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- CALCULATOR -->
                    <div class="row m-t-10">
                        <div class="col-md-12">
                            <div class="default-according style-1" id="ghg">
                                <div class="card">
                                    <div class="card-header bg-primary caruBackCol">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#ghg_emi" aria-expanded="true" aria-controls="collapse11">GHG Emissions</button>
                                        </h5>
                                    </div>
                                    <div class="collapse show" id="ghg_emi" aria-labelledby="ghg_emi" data-bs-parent="#ghg">
                                        <div class="row m-3">
                                            <div class="col-md-12">
                                                <div class="default-according style-2" id="inghg">
                                                    <div class="card">
                                                        <div class="card-header bg-primary caruBackCol1">
                                                            <h5 class="mb-0">
                                                                <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#scope_1" aria-expanded="true" aria-controls="collapse11">Scope 1</button>
                                                            </h5>
                                                        </div>
                                                        <div class="collapse" id="scope_1" aria-labelledby="scope_1" data-bs-parent="#accordionoc">
                                                            <div class="row">
                                                                <div class="col-md-12 text-center p-3 row">
                                                                    <div class="col-md-12 row mt-1">
                                                                        <div class="col-md-10"></div>
                                                                        <% if(user_type != 'V'){ %>
                                                                            <div class="col-md-2">
                                                                                <button class="btn btn-pill btn-sm btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Add New Calculator" onclick="AddCal('s1')"><i class="icofont icofont-ui-add"></i><span>&nbsp;&nbsp;Add</span></button>
                                                                            </div>
                                                                        <% } %>
                                                                    </div>
                                                                    <div class="col-md-12" id="calDetails_s1">
                                                                        <% if('s1' in ghg_emi_data){
                                                                            var sc_len = ghg_emi_data['s1'].length / 12;
                                                                            for(let sc = 1; sc <= sc_len; sc++){
                                                                                var newGhgDt = ghg_emi_data['s1'].filter(dt => dt.sl_no == sc && dt.scope == 's1')
                                                                                    %>
                                                                                    <div class="row">
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="type_id_s1_<%= sc %>">Section</label>
                                                                                            <select class="form-select" id="type_id_s1_<%= sc %>" name="type_id" required="" onchange="changeTypeId('s1','<%= sc %>')">
                                                                                                <option selected="" value="">Select Section</option>
                                                                                                <% if(type_list.length > 0){
                                                                                                    type_list.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].sec_id == dt.id)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt.id %>" dt-set="<%= dt.type %>" <%= selected %>><%= dt.type_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <script>
                                                                                            $(document).ready(async function(){
                                                                                                await changeTypeId('s1','<%= sc %>', '<%= newGhgDt[0].act_id %>')
                                                                                                await changeActId('s1','<%= sc %>', '<%= newGhgDt[0].emi_type_id %>')
                                                                                            })
                                                                                        </script>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="act_id_s1_<%= sc %>">Activity</label>
                                                                                            <select class="form-select" id="act_id_s1_<%= sc %>" name="act_id" required="" onchange="changeActId('s1','<%= sc %>')">
                                                                                                <option selected="" value="">Select Section</option>
                                                                                                <% if(act_list.length > 0){
                                                                                                    act_list.forEach(dt => { 
                                                                                                        var selected = ''; %>
                                                                                                        <option value="<%= dt.id %>"><%= dt.act_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="emi_type_id_s1_<%= sc %>">Emission Type</label>
                                                                                            <select class="form-select" id="emi_type_id_s1_<%= sc %>" name="emi_type_id" required="">
                                                                                                <option selected="" value="">Please select an emission type</option>
                                                                                                <% if(emi_type.length > 0){
                                                                                                    emi_type.forEach(dt => { 
                                                                                                        var selected = ''; %>
                                                                                                        <option value="<%= dt.id %>"><%= dt.emi_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="repo_period_s1_<%= sc %>">Reporting period</label>
                                                                                            <select class="form-select" id="repo_period_s1_<%= sc %>" name="repo_period" required="">
                                                                                                <option selected="" value="">Select One</option>
                                                                                                <% if(year_list.length > 0){
                                                                                                    year_list.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].repo_period == dt)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt %>" <%= selected %>><%= dt %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="strt_month_s1_<%= sc %>">Start Month</label>
                                                                                            <select class="form-select" id="strt_month_s1_<%= sc %>" name="strt_month" required="" onchange="calSelectMonth('s1','<%= sc %>')">
                                                                                                <option selected="" value="">Select One</option>
                                                                                                <% var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                                                                if(months.length > 0){
                                                                                                    months.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].repo_month == dt)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt %>" <%= selected %>><%= dt %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-12 m-t-10 table-responsive">
                                                                                            <table class="table table-bordered" id="cal_val_entry_table_s1_<%= sc %>">
                                                                                                <thead>
                                                                                                    <tr>
                                                                                                        <th>Month</th>
                                                                                                        <th>Unit</th>
                                                                                                        <th>Values</th>
                                                                                                        <th>Emission factors</th>
                                                                                                        <th>Kg CO2e</th>
                                                                                                    </tr>
                                                                                                </thead>
                                                                                                <tbody>
                                                                                                    <% if(newGhgDt.length > 0){
                                                                                                        var nextCalField = 1;
                                                                                                        newGhgDt.forEach(gdt => { %>
                                                                                                            <tr>
                                                                                                                <td><%= gdt.repo_month %></td>
                                                                                                                <td>
                                                                                                                    <select class="form-select" id="emi_type_unit_id_s1_<%= nextCalField %>_<%= sc %>" name="emi_type_unit_id" required="" onchange="setCalVal('s1', '<%= sc %>', '<%= nextCalField %>')">
                                                                                                                        <option selected="" value="">Please select unit of measurement</option>
                                                                                                                    </select>
                                                                                                                </td>
                                                                                                                <td><input class="form-control" id="cal_val_s1_<%= nextCalField %>_<%= sc %>" name="cal_val" type="text" value="<%= gdt.cal_val %>" required="" onchange="setCoVal('s1', '<%= sc %>', '<%= nextCalField %>')"></td>
                                                                                                                <td><input class="form-control" id="emi_fact_val_s1_<%= nextCalField %>_<%= sc %>" name="emi_fact_val" type="text" value="<%= gdt.emi_fact_val %>" required="" readonly></td>
                                                                                                                <td><input class="form-control" id="co_val_s1_<%= nextCalField %>_<%= sc %>" name="co_val" type="text" value="<%= gdt.co_val %>" required="" readonly onchange="setCoVal('s1', '<%= sc %>', '<%= nextCalField %>')"></td>
                                                                                                            </tr>
                                                                                                    <%  nextCalField++; })} %>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                        <% if(user_type != 'V'){ %>
                                                                                            <div class="col-md-10"></div>
                                                                                            <div class="col-md-2 m-t-10">
                                                                                                <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save" onclick="saveCalValue('s1','<%= sc %>')"><i class="icofont icofont-save"> Save</i></button>
                                                                                            </div>
                                                                                        <% } %>
                                                                                    </div>
                                                                                <% }
                                                                        }else{ %>
                                                                            <div class="row">
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="type_id_s1_1">Section</label>
                                                                                    <select class="form-select" id="type_id_s1_1" name="type_id" required="" onchange="changeTypeId('s1',1)">
                                                                                        <option selected="" value="">Select Section</option>
                                                                                        <% if(type_list.length > 0){
                                                                                            type_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>" dt-set="<%= dt.type %>"><%= dt.type_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="act_id_s1_1">Activity</label>
                                                                                    <select class="form-select" id="act_id_s1_1" name="act_id" required="" onchange="changeActId('s1',1)">
                                                                                        <option selected="" value="">Select Section</option>
                                                                                        <% if(act_list.length > 0){
                                                                                            act_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>"><%= dt.act_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="emi_type_id_s1_1">Emission Type</label>
                                                                                    <select class="form-select" id="emi_type_id_s1_1" name="emi_type_id" required="">
                                                                                        <option selected="" value="">Please select an emission type</option>
                                                                                        <% if(emi_type.length > 0){
                                                                                            emi_type.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>"><%= dt.emi_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="repo_period_s1_1">Reporting period</label>
                                                                                    <select class="form-select" id="repo_period_s1_1" name="repo_period" required="">
                                                                                        <option selected="" value="">Select One</option>
                                                                                        <% if(year_list.length > 0){
                                                                                            year_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt %>"><%= dt %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="strt_month_s1_1">Start Month</label>
                                                                                    <select class="form-select" id="strt_month_s1_1" name="strt_month" required="" onchange="calSelectMonth('s1',1)">
                                                                                        <option selected="" value="">Select One</option>
                                                                                        <% var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                                                        if(months.length > 0){
                                                                                            months.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt %>"><%= dt %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-12 m-t-10 table-responsive">
                                                                                    <table class="table table-bordered" id="cal_val_entry_table_s1_1">
                                                                                        <thead>
                                                                                            <tr>
                                                                                                <th>Month</th>
                                                                                                <th>Unit</th>
                                                                                                <th>Values</th>
                                                                                                <th>Emission factors</th>
                                                                                                <th>Kg CO2e</th>
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody></tbody>
                                                                                    </table>
                                                                                </div>
                                                                                <% if(user_type != 'V'){ %>
                                                                                    <div class="col-md-10"></div>
                                                                                    <div class="col-md-2 m-t-10">
                                                                                        <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save" onclick="saveCalValue('s1',1)"><i class="icofont icofont-save"> Save</i></button>
                                                                                    </div>
                                                                                <% } %>
                                                                            </div>
                                                                        <% } %>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card">
                                                        <div class="card-header bg-primary caruBackCol1">
                                                            <h5 class="mb-0">
                                                                <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#scope_2" aria-expanded="true" aria-controls="collapse11">Scope 2</button>
                                                            </h5>
                                                        </div>
                                                        <div class="collapse" id="scope_2" aria-labelledby="scope_2" data-bs-parent="#accordionoc">
                                                            <div class="row">
                                                                <div class="col-md-12 text-center p-3 row">
                                                                    <div class="col-md-12 row mt-1">
                                                                        <div class="col-md-10"></div>
                                                                        <% if(user_type != 'V'){ %>
                                                                            <div class="col-md-2">
                                                                                <button class="btn btn-pill btn-sm btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Add New Calculator" onclick="AddCal('s2')"><i class="icofont icofont-ui-add"></i><span>&nbsp;&nbsp;Add</span></button>
                                                                            </div>
                                                                        <% } %>
                                                                    </div>
                                                                    <div class="col-md-12" id="calDetails_s2">
                                                                        <% if('s2' in ghg_emi_data){
                                                                            var sc_len = ghg_emi_data['s2'].length / 12;
                                                                            for(let sc = 1; sc <= sc_len; sc++){
                                                                                var newGhgDt = ghg_emi_data['s2'].filter(dt => dt.sl_no == sc && dt.scope == 's2')
                                                                                %>
                                                                                    <div class="row">
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="type_id_s2_<%= sc %>">Section</label>
                                                                                            <select class="form-select" id="type_id_s2_<%= sc %>" name="type_id" required="" onchange="changeTypeId('s2','<%= sc %>')">
                                                                                                <option selected="" value="">Select Section</option>
                                                                                                <% if(type_list.length > 0){
                                                                                                    type_list.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].sec_id == dt.id)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt.id %>" dt-set="<%= dt.type %>" <%= selected %>><%= dt.type_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <script>
                                                                                            $(document).ready(async function(){
                                                                                                await changeTypeId('s2','<%= sc %>', '<%= newGhgDt[0].act_id %>')
                                                                                                await changeActId('s2','<%= sc %>', '<%= newGhgDt[0].emi_type_id %>')
                                                                                            })
                                                                                        </script>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="act_id_s2_<%= sc %>">Activity</label>
                                                                                            <select class="form-select" id="act_id_s2_<%= sc %>" name="act_id" required="" onchange="changeActId('s2','<%= sc %>')">
                                                                                                <option selected="" value="">Select Section</option>
                                                                                                <% if(act_list.length > 0){
                                                                                                    act_list.forEach(dt => { 
                                                                                                        var selected = ''; %>
                                                                                                        <option value="<%= dt.id %>"><%= dt.act_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="emi_type_id_s2_<%= sc %>">Emission Type</label>
                                                                                            <select class="form-select" id="emi_type_id_s2_<%= sc %>" name="emi_type_id" required="">
                                                                                                <option selected="" value="">Please select an emission type</option>
                                                                                                <% if(emi_type.length > 0){
                                                                                                    emi_type.forEach(dt => { 
                                                                                                        var selected = ''; %>
                                                                                                        <option value="<%= dt.id %>"><%= dt.emi_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="repo_period_s2_<%= sc %>">Reporting period</label>
                                                                                            <select class="form-select" id="repo_period_s2_<%= sc %>" name="repo_period" required="">
                                                                                                <option selected="" value="">Select One</option>
                                                                                                <% if(year_list.length > 0){
                                                                                                    year_list.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].repo_period == dt)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt %>" <%= selected %>><%= dt %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="strt_month_s2_<%= sc %>">Start Month</label>
                                                                                            <select class="form-select" id="strt_month_s2_<%= sc %>" name="strt_month" required="" onchange="calSelectMonth('s2','<%= sc %>')">
                                                                                                <option selected="" value="">Select One</option>
                                                                                                <% var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                                                                if(months.length > 0){
                                                                                                    months.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].repo_month == dt)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt %>" <%= selected %>><%= dt %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-12 m-t-10 table-responsive">
                                                                                            <table class="table table-bordered" id="cal_val_entry_table_s2_<%= sc %>">
                                                                                                <thead>
                                                                                                    <tr>
                                                                                                        <th>Month</th>
                                                                                                        <th>Unit</th>
                                                                                                        <th>Values</th>
                                                                                                        <th>Emission factors</th>
                                                                                                        <th>Kg CO2e</th>
                                                                                                    </tr>
                                                                                                </thead>
                                                                                                <tbody>
                                                                                                    <% if(newGhgDt.length > 0){
                                                                                                        var nextCalField = 1;
                                                                                                        newGhgDt.forEach(gdt => { %>
                                                                                                            <tr>
                                                                                                                <td><%= gdt.repo_month %></td>
                                                                                                                <td>
                                                                                                                    <select class="form-select" id="emi_type_unit_id_s2_<%= nextCalField %>_<%= sc %>" name="emi_type_unit_id" required="" onchange="setCalVal('s2', '<%= sc %>', '<%= nextCalField %>')">
                                                                                                                        <option selected="" value="">Please select unit of measurement</option>
                                                                                                                    </select>
                                                                                                                </td>
                                                                                                                <td><input class="form-control" id="cal_val_s2_<%= nextCalField %>_<%= sc %>" name="cal_val" type="text" value="<%= gdt.cal_val %>" required="" onchange="setCoVal('s2', '<%= sc %>', '<%= nextCalField %>')"></td>
                                                                                                                <td><input class="form-control" id="emi_fact_val_s2_<%= nextCalField %>_<%= sc %>" name="emi_fact_val" type="text" value="<%= gdt.emi_fact_val %>" required="" readonly></td>
                                                                                                                <td><input class="form-control" id="co_val_s2_<%= nextCalField %>_<%= sc %>" name="co_val" type="text" value="<%= gdt.co_val %>" required="" readonly onchange="setCoVal('s2', '<%= sc %>', '<%= nextCalField %>')"></td>
                                                                                                            </tr>
                                                                                                    <%  nextCalField++; })} %>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                        <% if(user_type != 'V'){ %>
                                                                                            <div class="col-md-10"></div>
                                                                                            <div class="col-md-2 m-t-10">
                                                                                                <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save" onclick="saveCalValue('s2','<%= sc %>')"><i class="icofont icofont-save"> Save</i></button>
                                                                                            </div>
                                                                                        <% } %>
                                                                                    </div>
                                                                                <%
                                                                            }
                                                                        }else{ %>
                                                                            <div class="row">
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="type_id_s2_1">Section</label>
                                                                                    <select class="form-select" id="type_id_s2_1" name="type_id" required="" onchange="changeTypeId('s2',1)">
                                                                                        <option selected="" value="">Select Section</option>
                                                                                        <% if(type_list.length > 0){
                                                                                            type_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>" dt-set="<%= dt.type %>"><%= dt.type_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="act_id_s2_1">Activity</label>
                                                                                    <select class="form-select" id="act_id_s2_1" name="act_id" required="" onchange="changeActId('s2',1)">
                                                                                        <option selected="" value="">Select Section</option>
                                                                                        <% if(act_list.length > 0){
                                                                                            act_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>"><%= dt.act_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="emi_type_id_s2_1">Emission Type</label>
                                                                                    <select class="form-select" id="emi_type_id_s2_1" name="emi_type_id" required="">
                                                                                        <option selected="" value="">Please select an emission type</option>
                                                                                        <% if(emi_type.length > 0){
                                                                                            emi_type.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>"><%= dt.emi_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="repo_period_s2_1">Reporting period</label>
                                                                                    <select class="form-select" id="repo_period_s2_1" name="repo_period" required="">
                                                                                        <option selected="" value="">Select One</option>
                                                                                        <% if(year_list.length > 0){
                                                                                            year_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt %>"><%= dt %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="strt_month_s2_1">Start Month</label>
                                                                                    <select class="form-select" id="strt_month_s2_1" name="strt_month" required="" onchange="calSelectMonth('s2',1)">
                                                                                        <option selected="" value="">Select One</option>
                                                                                        <% var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                                                        if(months.length > 0){
                                                                                            months.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt %>"><%= dt %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-12 m-t-10 table-responsive">
                                                                                    <table class="table table-bordered" id="cal_val_entry_table_s2_1">
                                                                                        <thead>
                                                                                            <tr>
                                                                                                <th>Month</th>
                                                                                                <th>Unit</th>
                                                                                                <th>Values</th>
                                                                                                <th>Emission factors</th>
                                                                                                <th>Kg CO2e</th>
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody></tbody>
                                                                                    </table>
                                                                                </div>
                                                                                <% if(user_type != 'V'){ %>
                                                                                    <div class="col-md-10"></div>
                                                                                    <div class="col-md-2 m-t-10">
                                                                                        <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save" onclick="saveCalValue('s2',1)"><i class="icofont icofont-save"> Save</i></button>
                                                                                    </div>
                                                                                <% } %>
                                                                            </div>
                                                                        <% } %>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card">
                                                        <div class="card-header bg-primary caruBackCol1">
                                                            <h5 class="mb-0">
                                                                <button class="btn btn-link text-white" data-bs-toggle="collapse" data-bs-target="#scope_3" aria-expanded="true" aria-controls="collapse11">Scope 3</button>
                                                            </h5>
                                                        </div>
                                                        <div class="collapse" id="scope_3" aria-labelledby="scope_3" data-bs-parent="#accordionoc">
                                                            <div class="row">
                                                                <div class="col-md-12 text-center p-3 row">
                                                                    <div class="col-md-12 row mt-1">
                                                                        <div class="col-md-10"></div>
                                                                        <% if(user_type != 'V'){ %>
                                                                            <div class="col-md-2">
                                                                                <button class="btn btn-pill btn-sm btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Add New Calculator" onclick="AddCal('s3')"><i class="icofont icofont-ui-add"></i><span>&nbsp;&nbsp;Add</span></button>
                                                                            </div>
                                                                        <% } %>
                                                                    </div>
                                                                    <div class="col-md-12" id="calDetails_s3">
                                                                        <% if('s3' in ghg_emi_data){
                                                                            var sc_len = ghg_emi_data['s3'].length / 12;
                                                                            for(let sc = 1; sc <= sc_len; sc++){
                                                                                var newGhgDt = ghg_emi_data['s3'].filter(dt => dt.sl_no == sc && dt.scope == 's3')
                                                                                %>
                                                                                    <div class="row">
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="type_id_s3_<%= sc %>">Section</label>
                                                                                            <select class="form-select" id="type_id_s3_<%= sc %>" name="type_id" required="" onchange="changeTypeId('s3','<%= sc %>')">
                                                                                                <option selected="" value="">Select Section</option>
                                                                                                <% if(type_list.length > 0){
                                                                                                    type_list.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].sec_id == dt.id)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt.id %>" dt-set="<%= dt.type %>" <%= selected %>><%= dt.type_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <script>
                                                                                            $(document).ready(async function(){
                                                                                                await changeTypeId('s3','<%= sc %>', '<%= newGhgDt[0].act_id %>')
                                                                                                await changeActId('s3','<%= sc %>', '<%= newGhgDt[0].emi_type_id %>')
                                                                                            })
                                                                                        </script>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="act_id_s3_<%= sc %>">Activity</label>
                                                                                            <select class="form-select" id="act_id_s3_<%= sc %>" name="act_id" required="" onchange="changeActId('s3','<%= sc %>')">
                                                                                                <option selected="" value="">Select Section</option>
                                                                                                <% if(act_list.length > 0){
                                                                                                    act_list.forEach(dt => { 
                                                                                                        var selected = ''; %>
                                                                                                        <option value="<%= dt.id %>"><%= dt.act_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="emi_type_id_s3_<%= sc %>">Emission Type</label>
                                                                                            <select class="form-select" id="emi_type_id_s3_<%= sc %>" name="emi_type_id" required="">
                                                                                                <option selected="" value="">Please select an emission type</option>
                                                                                                <% if(emi_type.length > 0){
                                                                                                    emi_type.forEach(dt => { 
                                                                                                        var selected = ''; %>
                                                                                                        <option value="<%= dt.id %>"><%= dt.emi_name %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="repo_period_s3_<%= sc %>">Reporting period</label>
                                                                                            <select class="form-select" id="repo_period_s3_<%= sc %>" name="repo_period" required="">
                                                                                                <option selected="" value="">Select One</option>
                                                                                                <% if(year_list.length > 0){
                                                                                                    year_list.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].repo_period == dt)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt %>" <%= selected %>><%= dt %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-6 m-t-10">
                                                                                            <label class="form-label float-start" for="strt_month_s3_<%= sc %>">Start Month</label>
                                                                                            <select class="form-select" id="strt_month_s3_<%= sc %>" name="strt_month" required="" onchange="calSelectMonth('s3','<%= sc %>')">
                                                                                                <option selected="" value="">Select One</option>
                                                                                                <% var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                                                                if(months.length > 0){
                                                                                                    months.forEach(dt => { 
                                                                                                        var selected = '';
                                                                                                        if(newGhgDt.length > 0)
                                                                                                            if(newGhgDt[0].repo_month == dt)
                                                                                                                selected = 'selected'; %>
                                                                                                        <option value="<%= dt %>" <%= selected %>><%= dt %></option>
                                                                                                    <% })
                                                                                                } %>
                                                                                            </select>
                                                                                        </div>
                                                                                        <div class="col-md-12 m-t-10 table-responsive">
                                                                                            <table class="table table-bordered" id="cal_val_entry_table_s3_<%= sc %>">
                                                                                                <thead>
                                                                                                    <tr>
                                                                                                        <th>Month</th>
                                                                                                        <th>Unit</th>
                                                                                                        <th>Values</th>
                                                                                                        <th>Emission factors</th>
                                                                                                        <th>Kg CO2e</th>
                                                                                                    </tr>
                                                                                                </thead>
                                                                                                <tbody>
                                                                                                    <% if(newGhgDt.length > 0){
                                                                                                        var nextCalField = 1;
                                                                                                        newGhgDt.forEach(gdt => { %>
                                                                                                            <tr>
                                                                                                                <td><%= gdt.repo_month %></td>
                                                                                                                <td>
                                                                                                                    <select class="form-select" id="emi_type_unit_id_s3_<%= nextCalField %>_<%= sc %>" name="emi_type_unit_id" required="" onchange="setCalVal('s3', '<%= sc %>', '<%= nextCalField %>')">
                                                                                                                        <option selected="" value="">Please select unit of measurement</option>
                                                                                                                    </select>
                                                                                                                </td>
                                                                                                                <td><input class="form-control" id="cal_val_s3_<%= nextCalField %>_<%= sc %>" name="cal_val" type="text" value="<%= gdt.cal_val %>" required="" onchange="setCoVal('s3', '<%= sc %>', '<%= nextCalField %>')"></td>
                                                                                                                <td><input class="form-control" id="emi_fact_val_s3_<%= nextCalField %>_<%= sc %>" name="emi_fact_val" type="text" value="<%= gdt.emi_fact_val %>" required="" readonly></td>
                                                                                                                <td><input class="form-control" id="co_val_s3_<%= nextCalField %>_<%= sc %>" name="co_val" type="text" value="<%= gdt.co_val %>" required="" readonly onchange="setCoVal('s3', '<%= sc %>', '<%= nextCalField %>')"></td>
                                                                                                            </tr>
                                                                                                    <%  nextCalField++; })} %>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </div>
                                                                                        <% if(user_type != 'V'){ %>
                                                                                            <div class="col-md-10"></div>
                                                                                            <div class="col-md-2 m-t-10">
                                                                                                <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save" onclick="saveCalValue('s3','<%= sc %>')"><i class="icofont icofont-save"> Save</i></button>
                                                                                            </div>
                                                                                        <% } %>
                                                                                    </div>
                                                                                <%
                                                                            }
                                                                        }else{ %>
                                                                            <div class="row">
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="type_id_s3_1">Section</label>
                                                                                    <select class="form-select" id="type_id_s3_1" name="type_id" required="" onchange="changeTypeId('s3',1)">
                                                                                        <option selected="" value="">Select Section</option>
                                                                                        <% if(type_list.length > 0){
                                                                                            type_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>" dt-set="<%= dt.type %>"><%= dt.type_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="act_id_s3_1">Activity</label>
                                                                                    <select class="form-select" id="act_id_s3_1" name="act_id" required="" onchange="changeActId('s3',1)">
                                                                                        <option selected="" value="">Select Section</option>
                                                                                        <% if(act_list.length > 0){
                                                                                            act_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>"><%= dt.act_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="emi_type_id_s3_1">Emission Type</label>
                                                                                    <select class="form-select" id="emi_type_id_s3_1" name="emi_type_id" required="">
                                                                                        <option selected="" value="">Please select an emission type</option>
                                                                                        <% if(emi_type.length > 0){
                                                                                            emi_type.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt.id %>"><%= dt.emi_name %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="repo_period_s3_1">Reporting period</label>
                                                                                    <select class="form-select" id="repo_period_s3_1" name="repo_period" required="">
                                                                                        <option selected="" value="">Select One</option>
                                                                                        <% if(year_list.length > 0){
                                                                                            year_list.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt %>"><%= dt %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-6 m-t-10">
                                                                                    <label class="form-label float-start" for="strt_month_s3_1">Start Month</label>
                                                                                    <select class="form-select" id="strt_month_s3_1" name="strt_month" required="" onchange="calSelectMonth('s3',1)">
                                                                                        <option selected="" value="">Select One</option>
                                                                                        <% var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                                                        if(months.length > 0){
                                                                                            months.forEach(dt => { 
                                                                                                var selected = ''; %>
                                                                                                <option value="<%= dt %>"><%= dt %></option>
                                                                                            <% })
                                                                                        } %>
                                                                                    </select>
                                                                                </div>
                                                                                <div class="col-md-12 m-t-10 table-responsive">
                                                                                    <table class="table table-bordered" id="cal_val_entry_table_s3_1">
                                                                                        <thead>
                                                                                            <tr>
                                                                                                <th>Month</th>
                                                                                                <th>Unit</th>
                                                                                                <th>Values</th>
                                                                                                <th>Emission factors</th>
                                                                                                <th>Kg CO2e</th>
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody></tbody>
                                                                                    </table>
                                                                                </div>
                                                                                <% if(user_type != 'V'){ %>
                                                                                    <div class="col-md-10"></div>
                                                                                    <div class="col-md-2 m-t-10">
                                                                                        <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save" onclick="saveCalValue('s3',1)"><i class="icofont icofont-save"> Save</i></button>
                                                                                    </div>
                                                                                <% } %>
                                                                            </div>
                                                                        <% } %>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" name="sec_id" id="sec_id" value="<%= sec_id %>">
<input type="hidden" name="ind_id" id="ind_id" value="<%= ind_id %>">
<input type="hidden" name="top_id" id="top_id" value="<%= top_id %>">
<input type="hidden" name="project_id" id="project_id" value="<%= project_id %>">

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.2.61/jspdf.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js" integrity="sha512-a9NgEEK7tsCvABL7KqtUTQjl69z7091EVPpw5KxPlZ93T141ffe1woLtbXTX+r2/8TtTvRX/v4zTL2UlMUPgwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- <script>
    function downloadPrf(divId){
        var divToPrint = document.getElementById(divId);
        var doc = new jsPDF();
        doc.fromHTML(`<html><head><title>Test</title></head><body style="width:100%;">` + divToPrint.innerHTML + `</body></html>`);
        doc.save('div.pdf');
        // html2canvas(divToPrint, {
        //   scale: 2 // Adjust the scale as needed for better quality
        // }).then(function(canvas) {
        //   const pdf = new jsPDF("p", "mm", "a4");
        //   pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
        //   pdf.save("output.pdf");
        // });
    }
</script> -->

<script>
    $(document).ready(function(){
        var reportType = '<%= repo_type %>';
        // console.log(reportType);
        $('.u-step').each(function(){
            if($(this).attr('dt-for').trim().split(' ').join('').toLowerCase() != reportType){
                $(this).removeClass('done')
                $(this).addClass('disabled')
            }
            else
                $(this).addClass('done')
        })
    })
</script>

<script>
    function downloadPrf(divId, title){
        var divToPrint = document.getElementById(divId);
        $.ajax({
            method: "POST",
            url: "/download_pdf",
            data: { pdfDiv: divToPrint.innerHTML },
            xhrFields: {
                responseType: 'blob' // Receive response as a binary blob
            },
            beforeSend: function () {
                $(".loader-wrapper").show();
            },
            success: function (data) {
            // Create a Blob URL for the PDF
                const pdfUrl = URL.createObjectURL(data);

                // Create an anchor element for downloading the PDF
                const a = document.createElement('a');
                a.href = pdfUrl;
                a.download = `${title}_${new Date().getTime()}.pdf`; // Set the desired filename
                a.style.display = 'none';

                // Append the anchor to the document body and trigger a click event
                document.body.appendChild(a);
                a.click();

                // Cleanup: Remove the anchor and revoke the Blob URL
                document.body.removeChild(a);
                URL.revokeObjectURL(pdfUrl);
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            },
            complete: function () {
                $(".loader-wrapper").hide();
            }
        })
    }
</script>

<script>
    function AddEditor(){
        var editorLength = $('textarea[name="editor"]').length
        $('#editorDiv').append(`
        <div id="editorNewDiv_${editorLength+1}" class="row">
            <div class="<%= ai_tag_tool_flag != 'N' ? 'col-md-8' : 'col-md-12' %> m-3 row">
                <div class="col-md-1">
                    <label for="" class="mb-3"> Title</label>
                </div>
                <div class="col-md-6">
                    <input class="form-control" type="text" name="editor_topic" id="editor_topic_${editorLength+1}" placeholder="Enter Title">
                </div>
                <div class="col-md-12"> 
                <textarea id="editor${editorLength+1}" name="editor" cols="30" rows="10"></textarea>
                </div>
            </div>
            <div class="col-md-8">&nbsp;</div>
            <div class="col-md-2">
                <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save" onclick="saveEditorValue(${editorLength+1}, 0)"><i class="icofont icofont-save"> Save</i></button>
            </div>
            <div class="col-md-2">
                <button class="btn btn-pill btn-outline-danger btn-air-danger float-end ml-2 text-center" data-bs-original-title title="Save" onclick="deleteEdotor(${editorLength+1})"><i class="icofont icofont-trash"> Delete</i></button>
            </div>
        </div>
        `)
        CKEDITOR
        .replace( `editor${editorLength+1}`, {
            on: {
                contentDom: function( evt ) {
                    // Allow custom context menu only with table elemnts.
                    evt.editor.editable().on( 'contextmenu', function( contextEvent ) {
                        var path = evt.editor.elementPath();

                        if ( !path.contains( 'table' ) ) {
                            contextEvent.cancel();
                        }
                    }, null, null, 5 );
                }
            }
        } );
    }
</script>

<script>
    function deleteEdotor(id){
        $('#editorNewDiv_'+id).remove()
    }
</script>

<script>
    function saveEditorValue(id, top_id){
        var topicTitle = $('#editor_topic_'+id).val()
        var txtEditorVal = CKEDITOR.instances['editor'+id].getData()
        // console.log(topicTitle, txtEditorVal);
        $.ajax({
            method:'POST',
            url: '/save_editor_data',
            data: {
                topicTilte: topicTitle, 
                txtEditorVal: txtEditorVal, 
                sec_id: $('#sec_id').val(), 
                ind_id: $('#ind_id').val(), 
                top_id: top_id,
                project_id: $('#project_id').val()
            },
            dataType: 'html',
            beforeSend: function(){
                $('.loader-wrapper').show()
            },
            success: function(result){
                var res = JSON.parse(result);
                
            },
            complete: function(){
                $('.loader-wrapper').hide()
            }
        })
    }
</script>
<script>
    const increseCount = (dt, id) => {
        // console.log(dt, 'dt');
        var totCountVal = totCount[id]
        var dataSet = wordList[id].trim().split(',')
        dataSet = dataSet.map(dt => dt.trim().toLowerCase());
        // console.log(totCountVal, 'totCountVal');
        // console.log(dataSet.includes(dt.trim().split('\n').join('').toLowerCase()), 'sadasd', dt);
        if(dataSet.includes(dt.trim().split('\n').join('').toLowerCase())){
            totCountVal += 1
            totCount[id] = totCountVal
            $(`#countMatchNum_${id}`).text(`${totCountVal}`)
            return dt.trim().split('\n').join('').toLowerCase().split(' ').join('');
        }
    }
</script>
<script>
    function changeTypeId(scope, id, act_id = 0){
        $(`label[for="emi_type_id_${scope}_${id}"]`).text($(`#type_id_${scope}_${id}`).attr('dt-set'))
        $.ajax({
            method:'POST',
            url: '/get_cal_act_ajax',
            data: {type_id: $(`#type_id_${scope}_${id}`).val()},
            dataType: 'html',
            beforeSend: function(){
                $('.loader-wrapper').show()
            },
            success: function(result){
                var res = JSON.parse(result);
                // console.log(res);
                $(`#act_id_${scope}_${id}`).empty();
                $(`#act_id_${scope}_${id}`).append($('<option>', {value: '', text: 'Select Activity'}));
                if(res.suc > 0 && res.msg.length > 0){
                    $.each(res.msg, function (i, item) {
                        var _selected = false
                        if(act_id > 0)
                            if(act_id == item.id)
                                _selected = true;
                        $(`#act_id_${scope}_${id}`).append($('<option>', {value: item.id, text: item.act_name, selected: _selected}));
                    });
                }
            },
            complete: function(){
                $('.loader-wrapper').hide()
            }
        })
    }
</script>
<script>
    function changeActId(scope, id, emi_type_id = 0){
        $.ajax({
            method:'POST',
            url: '/get_cal_emi_type_ajax',
            data: {type_id: $(`#type_id_${scope}_${id}`).val(), act_id: $(`#act_id_${scope}_${id}`).val()},
            dataType: 'html',
            beforeSend: function(){
                $('.loader-wrapper').show()
            },
            success: function(result){
                var res = JSON.parse(result);
                // console.log(res);
                $(`#emi_type_id_${scope}_${id}`).empty();
                $(`#emi_type_id_${scope}_${id}`).append($('<option>', {value: '', text: 'Select One'}));
                if(res.suc > 0 && res.msg.length > 0){
                    $.each(res.msg, function (i, item) {
                        var _selected = false
                        if(emi_type_id > 0)
                            if(emi_type_id == item.id)
                                _selected = true;
                        $(`#emi_type_id_${scope}_${id}`).append($('<option>', {value: item.id, text: item.emi_name, selected: _selected}));
                    });
                }
            },
            complete: function(){
                $('.loader-wrapper').hide()
            }
        })
    }
</script>
<script>
    function calUnitSet(scope, id){
        $.ajax({
            method:'POST',
            url: '/get_cal_unit_list_ajax',
            data: {type_id: $(`#type_id_${scope}_${id}`).val(), act_id: $(`#act_id_${scope}_${id}`).val(), emi_type_id: $(`#emi_type_id_${scope}_${id}`).val(), year: $(`#repo_period_${scope}_${id}`).val()},
            dataType: 'html',
            beforeSend: function(){
                $('.loader-wrapper').show()
            },
            success: function(result){
                var res = JSON.parse(result);
                for(let idt = 1; idt <= 12; idt++){
                    $(`#emi_type_unit_id_${scope}_${idt}_${id}`).empty()
                    $(`#cal_val_${scope}_${idt}_${id}`).val('')
                    $(`#emi_fact_val_${scope}_${idt}_${id}`).val('')
                    $(`#co_val_${scope}_${idt}_${id}`).val('')
                    $(`#emi_type_unit_id_${scope}_${idt}_${id}`).append($('<option>', {value: '', text: 'Please select unit of measurement'}));
                    if(res.suc > 0 && res.msg.length > 0){
                        $.each(res.msg, function (i, item) {
                            $(`#emi_type_unit_id_${scope}_${idt}_${id}`).append($('<option>', {value: item.unit_id, text: item.unit_name, dt_set: item.co_val}));
                        });
                    }
                }
            },
            complete: function(){
                $('.loader-wrapper').hide()
            }
        })
    }
    function setCalVal(scope, id, month){
        // console.log($(`#emi_type_unit_id_${month}_${id} :selected`).attr('dt_set'));
        $(`#emi_fact_val_${scope}_${month}_${id}`).val($(`#emi_type_unit_id_${scope}_${month}_${id} :selected`).attr('dt_set')).attr('readonly', 'readonly')

        var calVal = $(`#cal_val_${scope}_${month}_${id}`).val() > 0 ? $(`#cal_val_${scope}_${month}_${id}`).val() * $(`#emi_fact_val_${scope}_${month}_${id}`).val() : $(`#emi_fact_val_${scope}_${month}_${id}`).val()
        $(`#co_val_${scope}_${month}_${id}`).val(calVal.toFixed(2)).attr('readonly', 'readonly')
    }
    function setCoVal(scope, id, month){
        var calVal = $(`#cal_val_${scope}_${month}_${id}`).val() * $(`#emi_fact_val_${scope}_${month}_${id}`).val()
        $(`#co_val_${scope}_${month}_${id}`).val(calVal.toFixed(2)).attr('readonly', 'readonly')
        var tot_cal_val = 0, tot_co_val = 0;
        for(let idt = 1; idt <= 12; idt++){
            tot_cal_val += parseFloat($(`#cal_val_${scope}_${idt}_${id}`).val()) > 0 ? parseFloat($(`#cal_val_${scope}_${idt}_${id}`).val()) : 0;
            tot_co_val += parseFloat($(`#co_val_${scope}_${idt}_${id}`).val()) > 0 ? parseFloat($(`#co_val_${scope}_${idt}_${id}`).val()) : 0
        }
        $(`#tot_cal_val_${scope}_${id}`).text(tot_cal_val)
        $(`#tot_co_val_${scope}_${id}`).text(tot_co_val)
    }
</script>
<script>
    function AddCal(scope){
        var totCalFields = $(`#calDetails_${scope} table`).length,
            nextCalField = totCalFields + 1;
        $(`#calDetails_${scope}`).append(`
        <hr class="calSeparetor">
        <div class="row m-t-15">
            <div class="col-md-6 m-t-10">
                <label class="form-label float-start" for="type_id_${scope}_${nextCalField}">Section</label>
                <select class="form-select" id="type_id_${scope}_${nextCalField}" name="type_id" required="" onchange="changeTypeId('${scope}', ${nextCalField})">
                    <option selected="" value="">Select Section</option>
                    <% if(type_list.length > 0){
                        type_list.forEach(dt => { 
                            var selected = ''; %>
                            <option value="<%= dt.id %>" dt-set="<%= dt.type %>"><%= dt.type_name %></option>
                        <% })
                    } %>
                </select>
            </div>
            <div class="col-md-6 m-t-10">
                <label class="form-label float-start" for="act_id_${scope}_${nextCalField}">Activity</label>
                <select class="form-select" id="act_id_${scope}_${nextCalField}" name="act_id" required="" onchange="changeActId('${scope}', ${nextCalField})">
                    <option selected="" value="">Select Section</option>
                    <% if(act_list.length > 0){
                        act_list.forEach(dt => { 
                            var selected = ''; %>
                            <option value="<%= dt.id %>"><%= dt.act_name %></option>
                        <% })
                    } %>
                </select>
            </div>
            <div class="col-md-6 m-t-10">
                <label class="form-label float-start" for="emi_type_id_${scope}_${nextCalField}">Emission Type</label>
                <select class="form-select" id="emi_type_id_${scope}_${nextCalField}" name="emi_type_id" required="" onchange="calUnitSet('${scope}', ${nextCalField})">
                    <option selected="" value="">Please select an emission type</option>
                    <% if(emi_type.length > 0){
                        emi_type.forEach(dt => { 
                            var selected = ''; %>
                            <option value="<%= dt.id %>"><%= dt.emi_name %></option>
                        <% })
                    } %>
                </select>
            </div>
            <div class="col-md-6 m-t-10">
                <label class="form-label float-start" for="repo_period_${scope}_${nextCalField}">Reporting period</label>
                <select class="form-select" id="repo_period_${scope}_${nextCalField}" name="repo_period" required="">
                    <option selected="" value="">Select One</option>
                    <% if(year_list.length > 0){
                        year_list.forEach(dt => { 
                            var selected = ''; %>
                            <option value="<%= dt %>"><%= dt %></option>
                        <% })
                    } %>
                </select>
            </div>
            <div class="col-md-6 m-t-10">
                <label class="form-label float-start" for="strt_month_${scope}_${nextCalField}">Start Month</label>
                <select class="form-select" id="strt_month_${scope}_${nextCalField}" name="strt_month" required="" onchange="calSelectMonth('${scope}', ${nextCalField})">
                    <option selected="" value="">Select One</option>
                    <% var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    if(months.length > 0){
                        months.forEach(dt => { 
                            var selected = ''; %>
                            <option value="<%= dt %>"><%= dt %></option>
                        <% })
                    } %>
                </select>
            </div>
            <div class="col-md-12 m-t-10 table-responsive">
                <table class="table table-bordered" id="cal_val_entry_table_${scope}_${nextCalField}">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Unit</th>
                            <th>Values</th>
                            <th>Emission factors</th>
                            <th>Kg CO2e</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <% if(user_type != 'V'){ %>
                <div class="col-md-10"></div>
                <div class="col-md-2 m-t-10">
                    <button class="btn btn-pill btn-outline-primary btn-air-primary float-end text-center" data-bs-original-title title="Save" onclick="saveCalValue('${scope}',${nextCalField})"><i class="icofont icofont-save"> Save</i></button>
                </div>
            <% } %>
        </div>
        `)
    }
</script>
<script>
    function calSelectMonth(scope, id){
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var selMonth = $(`#strt_month_${scope}_${id}`).val()
        var selMonthIndex = months.findIndex(dt => dt === selMonth)
        var monthCount = selMonthIndex,
        currMonth = [];
        for(let dt of months){
            if(monthCount > (months.length-1)){
                monthCount = 0
            }
            currMonth.push(months[monthCount])
            monthCount++;
        }
        createCalTable(scope, id, currMonth)
        calUnitSet(scope, id)

    }
    function createCalTable(scope, id, months){
        var nextCalField = 1
        $(`#cal_val_entry_table_${scope}_${id} tbody`).empty()
        for(let m of months){
            $(`#cal_val_entry_table_${scope}_${id} tbody`).append(`
            <tr>
                <td>${m}</td>
                <td>
                    <select class="form-select" id="emi_type_unit_id_${scope}_${nextCalField}_${id}" name="emi_type_unit_id" required="" onchange="setCalVal('${scope}', ${id}, '${nextCalField}')">
                        <option selected="" value="">Please select unit of measurement</option>
                        <% if(emi_type.length > 0){
                            emi_type.forEach(dt => { 
                                var selected = ''; %>
                                <option value="<%= dt.id %>"><%= dt.emi_name %></option>
                            <% })
                        } %>
                    </select>
                </td>
                <td><input class="form-control" id="cal_val_${scope}_${nextCalField}_${id}" name="cal_val" type="text" value="" required="" onchange="setCoVal('${scope}', ${id}, '${nextCalField}')"></td>
                <td><input class="form-control" id="emi_fact_val_${scope}_${nextCalField}_${id}" name="emi_fact_val" type="text" value="" required=""></td>
                <td><input class="form-control" id="co_val_${scope}_${nextCalField}_${id}" name="co_val" type="text" value="" required="" onchange="setCoVal('${scope}', ${id}, '${nextCalField}')"></td>
            </tr>
            `)
            nextCalField++;
        }
        $(`#cal_val_entry_table_${scope}_${id} tbody`).append(`
        <tr>
            <td colspan="2">Total</td>
            <td><span id="tot_cal_val_${scope}_${id}"></span></td>
            <td></td>
            <td><span id="tot_co_val_${scope}_${id}"></span></td>
        </tr>
        `)
    }
    function saveCalValue(scope, id){
        var type_id = $(`#type_id_${scope}_${id}`).val(),
        act_id = $(`#act_id_${scope}_${id}`).val(),
        emi_type_id = $(`#emi_type_id_${scope}_${id}`).val(),
        repo_period = $(`#repo_period_${scope}_${id}`).val();
        
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var selMonth = $(`#strt_month_${scope}_${id}`).val()
        var selMonthIndex = months.findIndex(dt => dt === selMonth)
        var monthCount = selMonthIndex,
        currMonth = [];
        var req_data = [];
        for(let dt of months){
            if(monthCount > (months.length-1)){
                monthCount = 0
            }
            currMonth.push(months[monthCount])
            monthCount++;
        }
        console.log(type_id,act_id,emi_type_id,repo_period,currMonth);
        var m_i = 1
        for(let dt of currMonth){
            req_data.push({month: dt, emi_type_unit_id: $(`#emi_type_unit_id_${scope}_${m_i}_${id}`).val(), cal_val: $(`#cal_val_${scope}_${m_i}_${id}`).val(), emi_fact_val: $(`#emi_fact_val_${scope}_${m_i}_${id}`).val(), co_val: $(`#co_val_${scope}_${m_i}_${id}`).val()})
            m_i++;
        }

        $.ajax({
            method:'POST',
            url: '/save_ghg_emi_val',
            data: {sl_no: id, scope, sec_id: type_id, act_id, emi_type_id, repo_period, req_data: JSON.stringify(req_data)},
            dataType: 'html',
            beforeSend: function(){
                $('.loader-wrapper').show()
            },
            success: function(result){
                // var res = JSON.parse(result);
                console.log(result);
            },
            error: function(err){
                console.log(err);
            },
            complete: function(){
                $('.loader-wrapper').hide()
            }
        })
        console.log(req_data);
    }
</script>
<%- include('../templates/footer.ejs') %>