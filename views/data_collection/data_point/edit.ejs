<%- include('../../templates/header.ejs') %>
<div class="container-fluid">
  <div class="page-header">
    <div class="row">
      <div class="col-sm-6">
        <h3><%= header %></h3>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
          <li class="breadcrumb-item"><%= header %></li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
        <% if(message){ %>
            <script>
                setTimeout(() => {
                    initiate_sweet_alert('<%= header %>', '<%= message.message %>', "<%= message.type != 'danger' ? message.type : 'error' %>")
                }, 1000);
            </script>
        <% } %>
        </div>
        <div class="card">
            <div class="card-body">
                <form action="/data_point_entry" method="post" enctype="multipart/form-data">
                    <div class="row g-3 py-3">
                        <div class="col-md-8">
                            <label class="form-label" for="sec_id">Upload Logo For The Framework <%= frame_list[flag] %></label>
                            <input class="form-control" type="file" name="flag_img" id="flag_img" accept="image/*">
                        </div>
                        <div class="col-md-4" style="display: <%= ind_dt.flag_img && ind_dt.flag_img != '' ? 'block' : 'none' %>;">
                            <label class="form-label" for="sec_id">Preview Logo For The Framework <%= frame_list[flag] %></label>
                            <div class="up-img-prev">
                                <img src="<%= ind_dt.flag_img && ind_dt.flag_img != '' ? '/uploads/flag_icon/' + ind_dt.flag_img : '#' %>" alt="" id="prev_img">
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 py-3">
                        <div class="col-md-6">
                            <label class="form-label" for="sec_id">Sector</label>
                            <select class="form-select" id="sec_id" name="sec_id" required="">
                                <option selected="" value="">Select Sector</option>
                                <% if(sec_dt.length > 0){ 
                                    sec_dt.forEach(dt => {
                                        var _selected = ''; 
                                        if(dt.id == sec_id) _selected = 'selected';
                                %>
                                <option value="<%= dt.id %>" <%= _selected %>><%= dt.sec_name %></option>
                                <% }) } %>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="ind_id">Industries</label>
                            <select class="form-select" id="ind_id" name="ind_id" required="">
                              <option selected="" value="">Select Industries</option>
                              <% if(ind_list.length > 0){ 
                                  ind_list.forEach(dt => { 
                                      var _selected = ''; 
                                      if(dt.id == ind_id) _selected = 'selected'; 
                              %>
                              <option value="<%= dt.id %>" <%= _selected %>><%= dt.ind_name %></option>
                              <% }) } %>
                            </select>
                        </div>
                    </div>
                    <div class="row py-3" id="data_topic_table_div" style="display: none">
                        <div class="col-md-12">
                            <table class="table" id="data_topic_table">
                                <thead>
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 30%;">Code</th>
                                        <th style="width: 20%;">Framework</th>
                                        <th style="width: 40%;">Point</th>
                                        <th style="width: 5%;"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <input type="hidden" id="id" name="id" value="<%# id ? id : 0 %>">
                            <input type="hidden" id="flag" name="flag" value="<%= flag ? flag : '' %>">
                            <button class="btn btn-pill btn-outline-success btn-air-success my-3 float-end" type="submit">Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function(){
        var sec_id = '<%= sec_id > 0 ? sec_id : 0 %>';
        if(sec_id > 0){
            $('#sec_id').change()
        }
    })
    $('#flag_img').on('change', function(e){
        var file = e.target.files[0];
        // console.log(file);
        if(file){
            var fileName = file.name;
            var idxDot = fileName.lastIndexOf(".") + 1;
            var extFile = fileName.substr(idxDot, fileName.length).toLowerCase();
            if (extFile=="jpg" || extFile=="jpeg" || extFile=="png"){
                $('#prev_img').parent().parent().show()
                $('#prev_img').removeAttr('src')
                $('#prev_img').attr('src', URL.createObjectURL(file))
            }else{
                $('#prev_img').parent().parent().hide()
                $('#prev_img').removeAttr('src')
                $('#prev_img').attr('src', '#')
                $(this).val('')
                alert("Only jpg/jpeg and png files are allowed!");
            }
        }
    })

    $('#prev_img').on('click', function(){
        var src = $(this).attr('src');
        window.open(src, '_blank'); 
    })
</script>

<script>
    $('#sec_id').on('change', function(){
        var sec_id = $(this).val()
        if(sec_id > 0){
            $.ajax({
                method: "POST",
                url: "/get_data_topic_list_ajax",
                data: { sec_id: sec_id, flag: $('#flag').val() },
                dataType: "html",
                beforeSend: function () {
                    $(".loader-wrapper").show();
                },
                success: function (result) {
                    var res = JSON.parse(result); 
                    $("#ind_id").empty();
                    $("#data_set_view").hide()
                    $("#data_topic_table tbody >").remove()
                    $("#ind_id").append(
                    $("<option>", { value: "", text: "Select Industries" })
                    );
                    if (res.suc > 0 && res.msg.length > 0)
                    $.each(res.msg, function (i, item) {
                        $("#ind_id").append(
                        $("<option>", { value: item.ind_id, text: item.ind_name })
                        );
                    });
                },
                complete: function () {
                    $(".loader-wrapper").hide();
                },
            });
        }
    })

    $("#ind_id").on("change", function () {
        $.ajax({
            method: "GET",
            url: "/sus_disc_ajax",
            data: { ind_id: $(this).val(), sec_id: $("#sec_id").val(), flag: $('#flag').val() },
            dataType: "html",
            beforeSend: function () {
                $(".loader-wrapper").show();
            },
            success: function (result) {
                var res = JSON.parse(result);
                
                var frame_list = '<%- JSON.stringify(frame_list) %>';
                frame_list = JSON.parse(frame_list)
                var frame_opt = ''
                Object.keys(frame_list).forEach(dt => {
                    frame_opt = frame_opt + `<option value="${dt}">${frame_list[dt]}</option>`
                })
                
                if (res.suc > 0 && res.msg.length > 0) {
                    $('#data_topic_table_div').show()
                    $.each(res.msg, function (j, dt) {
                        if(dt.code != '' && dt.code)
                        $("#data_topic_table tbody").append(`
                        <tr id="row_${dt.id}_1">
                            <td>${j+1}</td>
                            <td>
                                <label>${dt.code}</label>
                                <input type="hidden" name="sus_dis_top_met_id" value="${dt.id}">
                            </td>
                            <td>
                                <select class="form-select" id="frame_id_${dt.id}_1" name="frame_id_${dt.id}" required="">
                                    ${frame_opt}
                                </select>
                            </td>
                            <td>
                                <textarea class="form-control" name="point_codes_${dt.id}" id="point_codes_${dt.id}" rows="3"></textarea>
                            </td>
                            <td>
                                <button type="button" class="btn btn-pill btn-outline-success btn-air-success" onclick="add_row(${dt.id}, 1)"><i class="icofont icofont-plus-circle"></i></button>    
                            </td>
                        </tr>
                        `)
                    })
                }
            },
            complete: function () {
                $(".loader-wrapper").hide();
            },
        })
    })

    function created_row(ind_id, id, prev_id = 0, frame_list='', sus_dis_top_met_id=''){
        // console.log(`${prev_id > 0 ? `#row_${top_id}_${prev_id}` : '#suc_disc_table tbody'}`);
        $(`${prev_id > 0 ? `#row_${id}_${prev_id}` : '#data_topic_table tbody'}`).after(`<tr id="row_${id}">
            ${prev_id > 0 ? '' : `<td rowspan="1" id="first_top_td_${top_id}" class="topic_text">${topic_name}<input type="hidden" name="top_id" value="${top_id}"></td>`}
            <td><input class="form-control" id="ind_agn_${top_id}_${id}" name="ind_agn_${top_id}" type="text" value="${ind_agn}"></td>
            <td><input class="form-control" id="metric_${top_id}_${id}" name="metric_${top_id}" type="text" value="${metric}"></td>
            <td><input class="form-control" id="catg_${top_id}_${id}" name="catg_${top_id}" type="text" value="${catg}"></td>
            <td><input class="form-control" id="unit_${top_id}_${id}" name="unit_${top_id}" type="text" value="${unit}"></td>
            <td><input class="form-control" id="code_${top_id}_${id}" name="code_${top_id}" type="text" value="${code}"></td>
            <td><textarea class="form-control" id="words_${top_id}_${id}" name="words_${top_id}" type="text" rows="3">${words}</textarea></td>
            <td>${prev_id > 0 ? `<button type="button" class="btn btn-pill btn-outline-danger btn-air-danger" onclick="remove_row(${top_id}, ${id}, ${sus_id})"><i class="icofont icofont-trash"></i></button>` : `<button type="button" class="btn btn-pill btn-outline-success btn-air-success" onclick="add_row(${top_id}, 1)"><i class="icofont icofont-plus-circle"></i></button>`}</td>
        </tr>`);
    }

    function add_row(top_id, id, ind_agn='', metric='', catg='', unit='', code='', words='', sus_id = 0) {
        var row = parseInt($(`#first_top_td_${top_id}`).attr("rowspan"));
        let next_id = row + 1;
        $(`#first_top_td_${top_id}`).removeAttr("rowspan");
        $(`#first_top_td_${top_id}`).attr("rowspan", next_id);
        created_row(top_id, next_id, row, ind_agn, metric, catg, unit, code, '', words, sus_id)
    }
</script>
<%- include('../../templates/footer.ejs') %>